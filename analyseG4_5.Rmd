---
title: "Graphique for rG4s"
author: Ana√Øs Vannutelli
date: 22/02/2018
output: 
   html_document: 
      toc: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The aim of this script is to build graphics of rG4s. Those graphics are composed of two "subgraphics". The first one represent the percent of rG4s in a localisation per subfamily. The second one represent the mean of the frequency of rG4s in localisation per subfamily.

The input is a file containing all information we need so there is no calculation here. The most important informations given by the input are for each localisation of a subfamilly : the number total of transcripts (with and without rG4s), the number of transcripts with rG4, the frequence of rG4s in a subfamily, the mean of frenquency of rG4s in a subfamily and the standard error.

With those inputs, we creat one data.frame per family. That means that one data.frame of a family will containt all the subfamily of it. To those data.frame we have added a column containing the subfamily and another column with the family. All data.frame are regrouped in a list.

# Initialisation

We will start by load all library needed, and our list (they can be change in fonction of the organism).

## Chargement of library

```{r}
library(ggplot2) # to make graphics
library(gridExtra) # to put two graphics one above the other
library("RColorBrewer") # to create a color palete
library(rlist) # to save the color palete
```

## Creation of list 

To create the graphics we want, we will need to have list contaning the name of all subfamily. In plus we initialise the list containing all family. There also is list for the subfamily of a specie.

```{r}
Coding=c('IG_C_gene', 'IG_D_gene', 'IG_J_gene', 'IG_LV_gene', 'IG_M_gene', 'IG_V_gene', 'IG_Z_gene', 'nonsense_mediated_decay', 'nontranslating_CDS', 'non_stop_decay', 'protein_coding', 'TR_C_gene', 'TR_D_gene', 'TR_gene', 'TR_J_gene', 'TR_V_gene')

Pseudogene=c('transcribed_unitary_pseudogene','disrupted_domain', 'IG_C_pseudogene', 'IG_J_pseudogene', 'IG_pseudogene', 'IG_V_pseudogene', 'processed_pseudogene', 'pseudogene', 'transcribed_processed_pseudogene', 'transcribed_unprocessed_pseudogene', 'translated_processed_pseudogene', 'translated_unprocessed_pseudogene', 'TR_J_pseudogene', 'TR_V_pseudogene', 'unitary_pseudogene', 'unprocessed_pseudogene','polymorphic_pseudogene')

LongNC=c('macro_lncRNA','bidirectional_promoter_lncRNA','sense_intronic','3prime_overlapping_ncRNA','ambiguous_orf','antisense','lincRNA','ncrna_host','non_coding','processed_transcript','retained_intron','sense_overlapping')

ShortNC=c('3prime_overlapping_ncRNA','scaRNA','miRNA', 'miRNA_pseudogene', 'misc_RNA', 'misc_RNA_pseudogene', 'Mt_rRNA' ,'Mt_tRNA', 'Mt_tRNA_pseudogene', 'ncRNA', 'pre_miRNA', 'RNase_MRP_RNA', 'RNase_P_RNA', 'rRNA', 'rRNA_pseudogene', 'scRNA_pseudogene', 'snlRNA', 'snoRNA', 'snoRNA_pseudogene', 'snRNA', 'snRNA_pseudogene', 'SRP_RNA', 'tmRNA', 'tRNA', 'tRNA_pseudogene')

Predictif=c('TEC')

NonCoding=c('macro_lncRNA','bidirectional_promoter_lncRNA','sense_intronic','3prime_overlapping_ncRNA','ambiguous_orf','antisense','lincRNA','ncrna_host','non_coding','processed_transcript','retained_intron','sense_overlapping','3prime_overlapping_ncRNA','scaRNA','miRNA', 'miRNA_pseudogene', 'misc_RNA', 'misc_RNA_pseudogene', 'Mt_rRNA' ,'Mt_tRNA', 'Mt_tRNA_pseudogene', 'ncRNA', 'pre_miRNA', 'RNase_MRP_RNA', 'RNase_P_RNA', 'rRNA', 'rRNA_pseudogene', 'scRNA_pseudogene', 'snlRNA', 'snoRNA', 'snoRNA_pseudogene', 'snRNA', 'snRNA_pseudogene', 'SRP_RNA', 'tmRNA', 'tRNA', 'tRNA_pseudogene')
SupraFamilyName=c('Coding', 'NonCoding', 'Pseudogene', 'Predictif')

NameFileMouse = c("3prime_overlapping_ncRNA","polymorphic_pseudogene","transcribed_processed_pseudogene","bidirectional_promoter_lncRNA","processed_pseudogene","transcribed_unitary_pseudogene","IG_C_gene","processed_transcript","transcribed_unprocessed_pseudogene","IG_V_gene","protein_coding","translated_processed_pseudogene","IG_V_pseudogene","pseudogene","TR_C_gene","lincRNA","retained_intron","TR_V_gene","macro_lncRNA","rRNA","TR_V_pseudogene","miRNA","sense_intronic","unitary_pseudogene","misc_RNA","sense_overlapping","unprocessed_pseudogene","nonsense_mediated_decay","snoRNA","non_stop_decay","TEC")

NameFileHuman = c("3prime_overlapping_ncRNA","antisense","bidirectional_promoter_lncRNA","IG_C_gene","IG_C_pseudogene","IG_V_gene","IG_V_geneUTR","IG_V_pseudogene","lincRNA","macro_lncRNA","miRNA","misc_RNA","non_coding","nonsense_mediated_decay","nonsense_mediated_decayUTR","non_stop_decay","non_stop_decayUTR","polymorphic_pseudogene","processed_pseudogene","processed_transcript","protein_coding","protein_codingUTR","pseudogene","retained_intron","rRNA","sense_intronic","sense_overlapping","TEC","transcribed_processed_pseudogene","transcribed_unitary_pseudogene","transcribed_unprocessed_pseudogene","TR_C_gene","TR_V_gene","TR_V_geneUTR","TR_V_pseudogene","unitary_pseudogene","unprocessed_pseudogene")

SupraFamily=list()
SupraFamily[[1]]=Coding
SupraFamily[[2]]=ShortNC
SupraFamily[[3]]=LongNC
SupraFamily[[4]]=Pseudogene
SupraFamily[[5]]=Predictif
AllSubFamilly = unique(c(Coding, Pseudogene, LongNC, ShortNC, Predictif))
```

# Fonction

Here we will describe all the function we need.

## Data import

First, we will import our Data in a list of data frame. One data frame will correspond to one family (Coding, NonCoding, Pseudogene, Predictif).

```{r}
DataImport = function(path, SupraFamily, NameFile) {
  Data_perFamily = list() # initialisation of the list
  for(j in seq(1,length(SupraFamily))){# for each family : Coding, NonCoding, Pseudogene, Predictif
    Data_perFamily[[j]] = data.frame() # initialisation of the family
    for(i in seq(1,length(NameFile))){# browse all subfamily
      if(is.element(NameFile[i], SupraFamily[[j]])){ # if the subfamily is in the family
        # choice of the family, it will be easier to do it know
        if(length(SupraFamily[[j]])==16){
          family = 'Coding'
        }else if(length(SupraFamily[[j]])==25){
          family = 'ShortNC'
        }else if(length(SupraFamily[[j]])==12){
          family = 'LongNC'
        }else if(length(SupraFamily[[j]])==17){
          family = 'Pseudogene'
        }else{
          family = 'Predictif'
        }
        filename=paste(path,NameFile[i], ".csv",  sep="") # creation of the input filename
        tmp = read.csv(filename, header = T, sep = "\t") # read the input file in a tmp
        tmp$subfamily = NameFile[i] # adding of the subfamily
        tmp$family= family # adding of the family
        Data_perFamily[[j]] = rbind(tmp, Data_perFamily[[j]]) # new subfamily add next to the other
      }
    }
  }
  return(Data_perFamily)
}
```

## Color

Here we will describe the choice of colors.

### All Color

We need to create a list of color for all subfamily but only once, then we saved it and it will be load after. 

```{r}
GetAllColor = function(ListeNom){
  getPalette = colorRampPalette(brewer.pal(12, "Paired"))
  subFamily = sort(ListeNom)
  subFamilyPalette = getPalette(length(subFamily))
  DicoColor = vector(mode="list", length=length(subFamily))
  for(i in seq(1,length(subFamily))){ # add of the colors in a list and associed it to a subfamily
    DicoColor[[i]] = subFamilyPalette[i] # add of the color
    names(DicoColor[[i]]) = subFamily[i] # association with a subfamily
  }
  return(DicoColor)
}

#saveRDS(AllColor, 'AllColor3.RData')
```

### Retrive the list of subfamily

Here, for one family we will retrieve the list of the subfamily present in one specie. This is need because for example the mouse doesn't pocess any rG4s in antisence RNA, yet human get rG4s in antisense RNA. So for each specie we need to get the list of subfamily in a family.

This list will be used to select colors later.

```{r}
GetListSubFam = function(Data, Family){
  nPerSubFamily = 0 # correspond to the number of localisation of a family
  if(Family == 'Coding'){
        nPerSubFamily = 9 # Coding family get nine localisation
  }else{
       nPerSubFamily = 5  # other family only get five localisation
  }
  ListSubFamilly = vector("character", length = length(Data)/nPerSubFamily)
  cpt=1
  for(i in seq(1, nrow(Data), nPerSubFamily)){
    ListSubFamilly[[cpt]] = Data$subfamily[i]
    cpt = cpt + 1
  }
  return(sort(ListSubFamilly))
}
```


### Colors for a family

Here, from a list of subfamily present in a family and the list containing all color we will create another list containing only the colors of a family and its subfamily.

```{r}
GetColor = function(ListSubFamily, ListColor){
  ListColorSubFamilly = vector("character", length = length(ListSubFamily))
  cpt = 1
  for(i in seq(1,length(ListColor))){ # browse of all the color
    nameColor = names(ListColor[[i]]) # retrieve the subfamily of the color
    if(is.element(nameColor, ListSubFamily)){ # if the subfamily is in the list of subfamily we keep it
      if(nameColor == "antisense"){
        ListColorSubFamilly[cpt]="#330066"
        cpt = cpt +1
      }else if(nameColor == "sense_intronic"){
        ListColorSubFamilly[cpt]="#42f4d7"
        cpt = cpt +1
        }else if(nameColor == "transcribed_unitary_pseudogene"){
        ListColorSubFamilly[cpt]="#71ecf7"
        cpt = cpt +1
        }else if(nameColor == "non_stop_decay"){
        ListColorSubFamilly[cpt]="#37509b"
        cpt = cpt +1
        }else if(nameColor == "translated_processed_pseudogene"){
        ListColorSubFamilly[cpt]="#3752a3"
        cpt = cpt +1
        }else{
        ListColorSubFamilly[cpt]=ListColor[[i]]
        cpt = cpt +1
      }
    }
  }
  return(ListColorSubFamilly)
}

#colorLongNC = GetColor(LongNC, AllColor)
```

## Graphics 

### Mean Graphic

Here the graphic about the mean of frequency will be done, in a function MeanGraphic(Data, family, ListColorSubfamily, specie). The parameter correspond to :

* Data : the list containing all the familly data frame
* family : the family of which you want the graphic.
* ListColorSubfamily : the list of the color of subfamily
* specie : the specie for which we are doing the graphics, it's only for the name of the graphics

The graphic is done thanks to the [tuto](http://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2/).

**Signification of the mean of frequency** : for each transcript, we compute the frequency of G4s in fonction of the position, then the mean of those frenquency is made in fonction of the localisation.

```{r}
MeanGraphic = function(Data, family, ListColorSubfamily, specie) {
  color = ListColorSubfamily # retrieve of the list of colors for a family
  if(length(which(Data$Percent == '0'))>0){ # to use facet_grid we must have not any 0 so we change them in 0.0001
      tmp = which(Data$Percent == '0')
      Data[tmp,]$Mean = 0.0001 # this value is to little to be seen in our graphics so it have no impact
  }
  
  p = ggplot(Data, aes(y=Mean, x=subfamily, fill=subfamily)) + # base of the graphic
      geom_bar(stat = "identity",position = position_dodge(0.9)) + # bar of the graphic
      facet_grid(".~ Localisation")+ # separation by localisation
      theme(axis.text.x=element_blank(), # removal of the axe x label
          axis.ticks.x=element_blank())
    
  p + geom_errorbar(aes(ymin=Mean-SE, ymax=Mean+SE),size=0.5, width=.25,position=position_dodge(.9)) + # error bar
      ggtitle(paste("Mean of frequency for each subfamilly of ", Data$family[1], " family (",specie,")", sep = ""))+ # title of the graphic
      scale_fill_manual(values = alpha(color, .8),name = "SubFamilly")+ # color + name of the legend
      facet_grid(".~ Localisation") # separation by localisation
}

#MeanGraphic(Data_Mouse_perFamily[[3]],'LongNC', LongNC)
```

### Percent Graphic

Same pipeline as the MeanGraphic(). It will produce the same graphic but this time ther is no error bar, and the y's axe corresponds to the percent of rG4s of each localisation and for each subfamily. Percent of transcript with G4 at this localisation for a subfamily.

```{r}
PercentGraphic = function(Data, family, ListColorSubfamily,specie) {
    color = ListColorSubfamily
    Data$subfamily = as.factor(Data$subfamily)
    if(length(which(Data$Percent == '0'))>0){
      tmp = which(Data$Percent == '0')
      Data[tmp,]$Percent = 0.0001
    }
    ggplot(Data, aes(y=Percent, x=subfamily, fill=paste(subfamily, " (",NbTRanscript,")", sep = ""))) + # idem + add of the nbtranscript in the legend
    geom_bar( stat="identity") +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())+
    geom_text(aes(label=NbTRanscriptWithG4), vjust=-0.3, position = position_dodge(0.9), size=3.5)+ # NbTRanscriptWithG4 above the bar
    ggtitle(paste("Percent of rG4s for each subfamilly of ", Data$family[1], " family (",specie,")", sep = ""))+
    facet_grid(".~ Localisation")+
    scale_fill_manual(values = alpha(color, .8),name = "SubFamilly")
    }

#PercentGraphic(Data_Human_perFamily[[3]], 'LongNC', LongNC)
#PercentGraphic(Data_Mouse_perFamily[[3]], 'LongNC', LongNC)
```

### Both graphic

This function will serve to make both graphic, one above the other.

```{r}
Graphic = function(Data, family, ListAllColor, specie){
  ListSubFamily = GetListSubFam(Data, family)
  ListColorSubfamily = GetColor(ListSubFamily,ListAllColor)
  grid.arrange(PercentGraphic(Data, family, ListColorSubfamily,specie), MeanGraphic(Data, family,ListColorSubfamily,specie), nrow=2)
  plot1 = PercentGraphic(Data, family, ListColorSubfamily,specie)
  plot2 = MeanGraphic(Data, family,ListColorSubfamily,specie)
  g <- arrangeGrob(plot1, plot2, nrow=2) #generates g
  return(g)
}

#Graphic(Data_Mouse_perFamily[[3]], 'Coding', LongNC)
#Graphic(Data_Human_perFamily[[3]], 'Coding', LongNC)
```

### All familly

```{r}
AllGraphe = function(Data, ListAllSubFamilly,specie,ListAllColor){
  #AllColor = GetAllColor(ListAllSubFamilly)
  for(i in seq(1,length(Data))){
    DataFamily = Data[[i]]
    Family = DataFamily$family[1]
    if(Family == 'ShortNC'){
        listSubFamily = ShortNC
      }else if(Family == 'LongNC'){
        listSubFamily = LongNC
      }else if(Family == 'Predictif'){
        listSubFamily = Predictif
      }else if(Family == 'Coding'){
        listSubFamily = Coding
      }else if(Family == 'Pseudogene'){
        listSubFamily = Pseudogene
      }
    g = Graphic(DataFamily, Family, ListAllColor,specie)
    #ggsave(file=paste(specie,"_",Family,".png",sep = ""), g,width=20, height=10, dpi=300) # to save the graphe in file
  }
}
```

# Main

## Import of Data
```{r}
pathMousePrac='/home/anais/Documents/Data/Mouse/All/Subset/'
pathHumanPrac='/home/anais/Documents/Data/Human/All/Subset/'
#pathMouseCoBius = '/home/local/USHERBROOKE/vana2406/Documents/Data/mouse/All/Subset/'
#pathHumanCoBius = '/home/local/USHERBROOKE/vana2406/Documents/Data/human/Subset/'
#pathMacMouse = '/Users/patate/Documents/Data/mouse/All/Subset/'
#pathMacHuman = '/Users/patate/Documents/Data/human/All/Subset/'

AllColor = GetAllColor(AllSubFamilly)

Data_Mouse_perFamily = list()
Data_Mouse_perFamily = DataImport(pathMousePrac, SupraFamily, NameFileMouse) # import of the mouse data

Data_Human_perFamily = list()
Data_Human_perFamily = DataImport(pathHumanPrac, SupraFamily, NameFileHuman) # import of the human
```

## Mouse graphics

```{r, fig.width=20, fig.height=10}
AllGraphe(Data_Mouse_perFamily, AllSubFamilly, "Mouse",AllColor) # generation of graphics for all familly of mouse
```

## Human graphics

```{r, fig.width=20, fig.height=10}
AllGraphe(Data_Human_perFamily, AllSubFamilly, "Human",AllColor) # generation of graphics for all familly of human
```
