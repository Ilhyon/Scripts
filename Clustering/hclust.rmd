---
title: 'rG4 : hierarchical clustering'
output: html_document
<<<<<<< HEAD
editor_options: 
  chunk_output_type: console
=======
>>>>>>> master
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Import of library

```{r}
#install.packages("stringi")
library("stringi")
#source("http://bioconductor.org/biocLite.R")
#biocLite("Biostrings")
library("Biostrings")
<<<<<<< HEAD
#install.packages("gplots", dependencies = TRUE)
library(gplots)
#install.packages("RColorBrewer", dependencies = TRUE)
library(RColorBrewer)
#install.packages("rafalib", dependencies = TRUE)
library(rafalib)
=======
>>>>>>> master
```

## Data processing

First we import the data of our G4.

```{r}
MM_All_G4InTranscript_Unique <- read.delim("~/Documents/Data/Mouse/All/MM_All_G4InTranscript_Unique.txt", row.names=1) # import of data
```

Then we compute the matrix with k-mer (here k = 3).

```{r}
fbio <- function(x){
    t(sapply(x, function(x){x1 <-  DNAString(x); oligonucleotideFrequency(x1,3)}))
}

DNAlst = MM_All_G4InTranscript_Unique$sequenceG4[1:100] # geting a subset of the data to test
name = rownames(MM_All_G4InTranscript_Unique)[1:100] # retrieve of the name of our data
kmer_matrix = fbio(DNAlst) # compute the matrix of k-mer
rownames(kmer_matrix) = name # add labels on the matrix
```

Now that we have the matrix of count for each k-mer in the rG4, we will normalise it by the length of the rG4. Like this, we could then compare result for rG4 with different length.

```{r}
rG4_string = MM_All_G4InTranscript_Unique$sequenceG4[1:100] # retrieve of the rG4 sequence
for(i in c(1:100)){ # loop to browse all sequence and convert it to character
  rG4_string[i] = as.character(rG4_string[i])
}
rG4_length = stri_length(rG4_string) # creqte a vector with the length of each rG4 sequences

normalized_kmer_matrix = kmer_matrix / rG4_length # normalisation by the length

d = dist(normalized_kmer_matrix, method = "euclidean")
```

## Clustering

At this point, we get our matrix of k-mer and we even normalised it in function of the length of sequences. It is time to do the clustering !

```{r}
<<<<<<< HEAD
hc = hclust(d, method = 'complete')
plot(hc,labels=name,cex=0.5)
hclusters <- cutree(hc, k=6)
table(true=name, cluster=hclusters)
normalized_kmer_matrix2<-cbind(normalized_kmer_matrix,hclusters)
```


```{r}
hc = hclust(d, method = 'complete')
dend = as.dendrogram(hc)
dend <- rotate(dend, 1:100)
dend <- color_branches(dend, k=6)
labels_colors(dend) <-
  rainbow_hcl(3)[sort_levels_values(
    as.numeric(hclusters)[order.dendrogram(dend)]
  )]
labels(dend) <- paste(as.character(hclusters)[order.dendrogram(dend)],
                      "(",labels(dend),")", 
                      sep = "")
dend <- hang.dendrogram(dend,hang_height=0.1)
dend <- set(dend, "labels_cex", 0.5)
some_col_func <- function(n) rev(colorspace::heat_hcl(n, c = c(80, 30), l = c(30, 90), power = c(1/5, 1.5)))
gplots::heatmap.2(as.matrix(normalized_kmer_matrix), 
                  main = "Heatmap for the Iris data set",
                  srtCol = 20,
                  dendrogram = "row",
                  Rowv = dend,
                  Colv = "NA", # this to make sure the columns are not ordered
                  trace="none",          
                  margins =c(5,0.1),      
                  key.xlab = "Cm",
                  denscol = "grey",
                  density.info = "density",
                  RowSideColors = rev(labels_colors(dend)), # to add nice colored strips        
                  col = some_col_func
)
```



```{r}
# cluster rows
hc.rows <- hclust(dist(normalized_kmer_matrix))
plot(hc.rows, cex=0.3)

# transpose the matrix and cluster columns
hc.cols <- hclust(dist(t(normalized_kmer_matrix)))

# draw heatmap for first cluster
heatmap(normalized_kmer_matrix[cutree(hc.rows,k=2)==1,], Colv=as.dendrogram(hc.cols), scale='none')

# draw heatmap for second cluster
heatmap(normalized_kmer_matrix[cutree(hc.rows,k=2)==2,], Colv=as.dendrogram(hc.cols), scale='none')
```
=======
dendro = hclust(d, method = 'ward.D')
plot(dendro, hang = -1) # hang pour l'axe commence Ã  zero
heatmap(as.dendro(dendro))
```







>>>>>>> master






